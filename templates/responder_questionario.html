{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<div class="container py-5">
    <div class="mb-5">
        <div class="progress" style="height: 10px; border-radius: 10px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: {{ progresso }}%; background-color: var(--somnus-green-dark);"></div>
        </div>
        <div class="text-center mt-2">
            <small class="text-muted">Etapa {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</small>
        </div>
    </div>

    <form method="post" id="form-questionario">
        {% csrf_token %}
        
        <div class="mb-5">
            <h2 class="fw-bold mb-3" style="color: var(--somnus-blue-deep);">{{ secao.titulo }}</h2>
            {% if secao.instrucao %}
                <div class="alert alert-light border-start border-4 border-primary mb-4 shadow-sm">
                    {{ secao.instrucao|linebreaks }}
                </div>
            {% endif %}

            {% if secao.layout == 'TABELA' %}
                <div class="table-responsive card shadow-sm rounded-4 p-3 border-0">
                    <table class="table align-middle">
                        <thead>
                            <tr>
                                <th>Questão</th>
                                {% for alt in secao.perguntas.first.alternativas.all %}
                                    <th class="text-center">{{ alt.conteudo }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for pergunta in secao.perguntas.all %}
                                <tr>
                                    <td class="small fw-bold">{{ pergunta.conteudo }}</td>
                                    {% for alternativa in pergunta.alternativas.all %}
                                        <td class="text-center">
                                            <input class="form-check-input" type="radio" 
                                                   name="pergunta_{{ pergunta.id }}" 
                                                   value="{{ alternativa.id }}"
                                                   {% if respostas_preenchidas|get_item:pergunta.id == alternativa.id|stringformat:"s" %}checked{% endif %}
                                                   required>
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                {% for pergunta in secao.perguntas.all %}
                    <div class="card border-0 shadow-sm mb-4 rounded-4">
                        <div class="card-body p-4">
                            <h5 class="fw-bold mb-3" style="color: var(--somnus-blue-deep);">{{ pergunta.conteudo }}</h5>
                            
                            {% if pergunta.tipo == 'MC' %}
                                {% for alternativa in pergunta.alternativas.all %}
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" 
                                               name="pergunta_{{ pergunta.id }}" 
                                               value="{{ alternativa.id }}"
                                               {% if respostas_preenchidas|get_item:pergunta.id == alternativa.id|stringformat:"s" %}checked{% endif %}
                                               required>
                                        <label class="form-check-label">{{ alternativa.conteudo }}</label>
                                    </div>
                                {% endfor %}
                            {% elif pergunta.tipo == 'TX' %}
                                <div class="mt-2">
                                    <input type="text" name="pergunta_{{ pergunta.id }}" 
                                           class="form-control bg-light border-0 rounded-3 p-3" 
                                           placeholder="Sua resposta..."
                                           value="{{ respostas_preenchidas|get_item:pergunta.id|default:'' }}"
                                           required>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="d-flex justify-content-between mt-5">
            {% if page_obj.has_previous %}
                <button type="submit" name="acao" value="anterior" class="btn btn-outline-secondary rounded-pill px-4 fw-bold">
                    ← Voltar
                </button>
            {% else %}
                <div></div>
            {% endif %}

            {% if page_obj.has_next %}
                <button type="submit" name="acao" value="proximo" class="btn btn-primary rounded-pill px-5 fw-bold shadow-sm" style="background-color: var(--somnus-blue-deep); border: none;">
                    Próxima Etapa →
                </button>
            {% else %}
                <button type="submit" name="acao" value="finalizar" class="btn btn-success rounded-pill px-5 fw-bold shadow-sm" style="background-color: var(--somnus-green-dark); border: none;">
                    Finalizar Avaliação
                </button>
            {% endif %}
        </div>
    </form>
</div>
{% endblock %}