{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<script src="https://unpkg.com/imask"></script>

<div class="container py-5">
    <div class="mb-5">
        <div class="progress" style="height: 10px; border-radius: 10px;">
            <div class="progress-bar" role="progressbar" style="width: {{ progresso }}%; background-color: var(--somnus-green-dark);"></div>
        </div>
    </div>

    <form method="post" id="form-questionario" novalidate>
        {% csrf_token %}
        
        <h2 class="fw-bold mb-4" style="color: var(--somnus-blue-deep);">{{ secao.titulo }}</h2>
        
        {% if secao.instrucao %}
            <div class="card border-0 shadow-sm mb-4 rounded-4 border-light-subtle" style="background-color: #fcfcfc;">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-0" style="color: var(--somnus-blue-deep); line-height: 1.5;">
                        {{ secao.instrucao|linebreaksbr }} 
                    </h5>
                </div>
            </div>
        {% endif %}

        {% for pergunta in secao.perguntas.all %}
            <div class="card border-0 shadow-sm mb-4 rounded-4 pergunta-card border-light-subtle" 
                 id="card_pergunta_{{ pergunta.id }}"
                 data-pergunta-id="{{ pergunta.id }}"
                 data-tipo="{{ pergunta.tipo }}"
                 data-obrigatoria="{{ pergunta.obrigatoria|yesno:'true,false' }}"
                 data-config-mista="{{ pergunta.config_mista }}"
                 
                 data-depende-alts="{% for alt in pergunta.depende_de_alternativa.all %}{{ alt.id }}{% if not forloop.last %},{% endif %}{% endfor %}" 
                 
                 data-depende-texto-id="{{ pergunta.depende_de_texto_de.id|default:'' }}"
                 
                 {% if pergunta.depende_de_alternativa.exists or pergunta.depende_de_texto_de %}
                    style="display: none;" 
                 {% endif %}>
                
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3">
                        {{ pergunta.conteudo }}
                        {% if pergunta.obrigatoria %}
                            <span class="text-danger" title="Obrigatório">*</span>
                        {% endif %}
                    </h5>

                    {% if pergunta.tipo == 'TX' or pergunta.tipo == 'MX' %}
                        <div class="mb-3">
                            <label class="small text-muted mb-1">Especifique ou complete se necessário:</label>
                            <input type="text" 
                                   name="pergunta_{{ pergunta.id }}_texto" 
                                   class="form-control bg-light border-0 rounded-3 p-3 input-pergunta input-texto-mista"
                                   data-mascara="{{ pergunta.mascara|default:'NENHUMA' }}"
                                   value="{{ respostas_preenchidas|get_item_key:pergunta.id|get_val:'texto'|default:'' }}">
                        </div>
                    {% endif %}

                    {% if pergunta.tipo == 'MC' or pergunta.tipo == 'MX' %}
                        <div class="d-flex flex-wrap gap-3">
                            {% for alternativa in pergunta.alternativas.all %}
                                <div class="form-check">
                                    <input class="form-check-input alternativa-radio" 
                                           type="radio" 
                                           name="pergunta_{{ pergunta.id }}" 
                                           id="alt_{{ alternativa.id }}"
                                           value="{{ alternativa.id }}"
                                           {% if respostas_preenchidas|get_item_key:pergunta.id|get_val:'alternativa' == alternativa.id|stringformat:"s" %}checked{% endif %}>
                                    <label class="form-check-label" for="alt_{{ alternativa.id }}">
                                        {{ alternativa.conteudo }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}

        <div class="d-flex justify-content-between mt-5">
            {% if page_obj.has_previous %}
                <button type="submit" name="acao" value="anterior" class="btn btn-outline-secondary rounded-pill px-4 fw-bold">Voltar</button>
            {% else %}
                <div></div>
            {% endif %}

            {% if page_obj.has_next %}
                <button type="submit" name="acao" value="proximo" class="btn btn-primary rounded-pill px-5 fw-bold shadow-sm" style="background-color: var(--somnus-blue-deep); border: none;">Próximo</button>
            {% else %}
                <button type="submit" name="acao" value="finalizar" class="btn btn-success rounded-pill px-5 fw-bold shadow-sm" style="background-color: var(--somnus-green-dark); border: none;">Finalizar</button>
            {% endif %}
        </div>
    </form>
</div>

{% include 'modal_tcle.html' %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('form-questionario');
    const radios = document.querySelectorAll('.alternativa-radio');
    const inputsTexto = document.querySelectorAll('.input-pergunta');

    // --- LÓGICA DE MÁSCARAS DE INPUT (IMask) ---
    function aplicarMascaras() {
        document.querySelectorAll('input[data-mascara]').forEach(input => {
            const tipo = input.dataset.mascara;
            if (tipo === 'HORA') {
                IMask(input, {
                    mask: 'HH:mm',
                    blocks: {
                        HH: { mask: IMask.MaskedRange, from: 0, to: 23 },
                        mm: { mask: IMask.MaskedRange, from: 0, to: 59 }
                    }
                });
            } else if (tipo === 'ALTURA') {
                IMask(input, {
                    mask: 'num m',
                    lazy: false,
                    blocks: {
                        num: { mask: Number, scale: 2, signed: false, radix: ',', mapToRadix: ['.'], from: 0, to: 3 }
                    }
                });
            } else if (tipo === 'PESO') {
                IMask(input, {
                    mask: 'num kg',
                    lazy: false,
                    blocks: {
                        num: { mask: Number, scale: 1, signed: false, radix: ',', mapToRadix: ['.'], from: 0, to: 500 }
                    }
                });
            } else if (tipo === 'DATA') {
                IMask(input, { mask: Date, pattern: 'd/`m/`Y' });
            }
        });
    }

    // --- LÓGICA PARA DESMARCAR RÁDIO (TOGGLE) ---
    radios.forEach(radio => {
        radio.addEventListener('mousedown', function() {
            this.wasChecked = this.checked;
        });
        radio.addEventListener('click', function() {
            if (this.wasChecked) {
                this.checked = false;
                this.wasChecked = false;
                atualizarVisibilidade();
            }
        });
    });

    // --- LÓGICA DE VISIBILIDADE AVANÇADA ---
    function atualizarVisibilidade() {
        const selecionados = Array.from(document.querySelectorAll('.alternativa-radio:checked')).map(r => r.value);
        const textosPreenchidos = {};
        document.querySelectorAll('.pergunta-card').forEach(card => {
            const pId = card.dataset.perguntaId;
            const input = card.querySelector('input[type="text"]');
            textosPreenchidos[pId] = input ? input.value.trim().length > 0 : false;
        });

        document.querySelectorAll('.pergunta-card').forEach(card => {
            const depsAlts = card.dataset.dependeAlts ? card.dataset.dependeAlts.split(',') : [];
            const depTextoId = card.dataset.dependeTextoId;
            let atendeAlt = depsAlts.length === 0 || depsAlts[0] === "" || depsAlts.some(id => selecionados.includes(id));
            let atendeTexto = !depTextoId || textosPreenchidos[depTextoId];

            if (atendeAlt && atendeTexto) {
                card.style.display = 'block';
            } else {
                if (depsAlts.length > 0 || depTextoId) card.style.display = 'none';
            }
        });
    }

    // --- VALIDAÇÃO DE SUBMIT COM SCROLL ---
    form.addEventListener('submit', function(e) {
        if (e.submitter && e.submitter.value === 'anterior') return;
        let valido = true;
        let primeiraPerguntaErro = null;

        document.querySelectorAll('.pergunta-card').forEach(card => {
            if (card.style.display === 'none') return;
            const tipo = card.dataset.tipo;
            const obrigatoria = card.dataset.obrigatoria === 'true';
            const config = card.dataset.configMista;
            
            if (obrigatoria) {
                const radioMarcado = card.querySelector('input[type="radio"]:checked');
                const textoInput = card.querySelector('input[type="text"]');
                const textoPreenchido = textoInput && textoInput.value.trim() !== "";
                let erro = false;

                if (tipo === 'TX' && !textoPreenchido) erro = true;
                else if (tipo === 'MX') {
                    if (config === 'QUALQUER' && !radioMarcado && !textoPreenchido) erro = true;
                    else if (config === 'AMBOS' && (!radioMarcado || !textoPreenchido)) erro = true;
                    else if (config === 'APENAS_OPCAO' && !radioMarcado) erro = true;
                    else if (config === 'APENAS_TEXTO' && !textoPreenchido) erro = true;
                } else if (tipo === 'MC' && !radioMarcado) erro = true;

                if (erro) {
                    valido = false;
                    card.classList.add('border', 'border-danger');
                    if (!primeiraPerguntaErro) primeiraPerguntaErro = card;
                } else {
                    card.classList.remove('border', 'border-danger');
                }
            }
        });

        if (!valido) {
            e.preventDefault();
            primeiraPerguntaErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });

    radios.forEach(r => r.addEventListener('change', atualizarVisibilidade));
    inputsTexto.forEach(i => i.addEventListener('input', atualizarVisibilidade));

    // Inicialização
    aplicarMascaras();
    atualizarVisibilidade();
});
</script>
{% endblock %}